# NewPlayerPanel v3.0.6

## Возможности

### Модуль отслеживания жителей

Модуль отслеживания жителей предоставляет комплексный мониторинг и логирование событий смерти жителей:

- **Запись событий смерти**: Автоматически отслеживает все смерти жителей с полными метаданными
- **Идентификация убийцы**: Записывает имя игрока, UUID и связанную информацию
- **Отслеживание местоположения**: Сохраняет точные координаты (X, Y, Z) и название мира для каждого события
- **Определение типа жителя**: Определяет и записывает конкретный тип жителя
- **Сохранение зачарований**: Захватывает данные о зачарованиях из торговли с жителями
- **Интерактивные координаты**: Кликабельные координаты для мгновенной телепортации к месту смерти жителя
- **Кликабельный телепорт в уведомлениях**: Координаты в уведомлениях о смерти жителей кликабельны для быстрой телепортации
- **Автоматическое определение измерения**: Автоматическое определение правильного измерения (overworld/nether/end) для корректной телепортации между мирами
- **Расширенный поиск**: Запрос записей по имени игрока, координатам или комбинированным критериям
- **Система уведомлений**: Уведомления в реальном времени для администраторов с соответствующими разрешениями
- **Очистка данных**: Автоматическая очистка исторических записей на основе временных критериев

### Система ограничений игроков

Продвинутая система ограничений, позволяющая точный контроль над действиями игроков:

- **Множественные типы ограничений**: Поддержка ограничений EQUIPMENT, ITEM, ENTITY и COMMAND
- **Ограничения по умолчанию**: Автоматическое применение ограничений на основе времени игрока на сервере
- **Временной контроль**: Настройка временных или постоянных ограничений
- **Управление в игре**: Создание и изменение ограничений через командный интерфейс
- **Детализация действий**: Точная настройка ограничений с использованием типов действий (DAMAGE, USE, DROP, EQUIP, EXECUTE)
- **Персональные переопределения**: Применение индивидуальных ограничений, которые переопределяют настройки по умолчанию
- **Применение в реальном времени**: Ограничения проверяются и применяются каждые 0.1 секунды
- **Просмотр игроками**: Игроки могут просматривать свои активные ограничения с помощью `/restrictions`
- **Временные ограничения по умолчанию**: Ограничения по умолчанию считают время с первого входа игрока, а не с запуска сервера

### Защита спавна

Гибкая система защиты зон спавна с детальной настройкой:

- **Множественные зоны**: Создание неограниченного количества защищённых зон
- **Три типа геометрии зон**:
  - **CIRCLE** — круглая зона (центр + радиус, по умолчанию)
  - **RECT** — прямоугольная зона (два угла, задаются через `pos1`/`pos2`)
  - **POLY** — полигональная зона (произвольное количество вершин, минимум 3)
- **Редактирование зон**: Изменение радиуса, центра, мира, PvP/взрывов/огня, удаление вершин полигона — всё в игре
- **Команды управления**: Список зон, добавление и удаление зон (с подтверждением), перезагрузка конфига
- **Info и playtime**: Любой игрок может узнать состояние модуля и своё время в игре; админы — время любого игрока
- **Защита блоков**: Контроль ломания и установки блоков (**BLACKLIST**/*WHITELIST* режимы)
- **Защита взаимодействий**: Настройка разрешённых блоков для взаимодействия (верстаки, наковальни, эндерсундуки и т.д.)
- **Защита от PvP**: Запрет PvP в защищённых зонах
- **Защита от взрывов**: Блокировка TNT, криперов, кристаллов Энда и других взрывов
- **Защита от огня**: Предотвращение распространения огня
- **Bypass по времени игры**: Автоматическое снятие ограничений после определённого времени игры на сервере
- **Bypass по правам**: Возможность обхода защиты для администраторов

### Системы хранения

Несколько бэкендов хранения для максимальной гибкости:

- **Хранение YAML/JSON**: Файловое хранение с использованием формата JSON в директории данных плагина
- **База данных H2**: Легковесная встроенная база данных SQLite (по умолчанию, не требует настройки)
- **Поддержка MySQL**: Полная интеграция с базой данных MySQL с пулом соединений
- **Поддержка MariaDB**: Нативная поддержка базы данных MariaDB с оптимизированными запросами

### Локализация

Полная поддержка интернационализации:

- **Многоязычность**: Полная поддержка русского и английского языков включена
- **Расширяемость**: Легко добавить дополнительные языки через файлы сообщений
- **Настраиваемые сообщения**: Весь пользовательский текст может быть изменен через конфигурацию
- **Переключение языка в реальном времени**: Изменение языка без перезапуска сервера

---

## Команды

### Административные команды

| Команда          | Описание                                                                                            | Разрешение     | Пример использования                                                   |
| ----------------------- | ----------------------------------------------------------------------------------------------------------- | ------------------------ | ----------------------------------------------------------------------------------------- |
| `/npp reload`         | Перезагружает конфигурацию плагина и применяет изменения | `newplayerpanel.admin` | `/npp reload`                                                                           |
| `/npp addrestriction` | Создает новое определение ограничения                                     | `newplayerpanel.admin` | `/npp addrestriction elytra_ban EQUIPMENT EQUIP minecraft:elytra time:-1 default:false` |

**Синтаксис команды:**

```
/npp addrestriction <name> <type> <actions> [targets...] [time:N] [default:true/false]
```

### Команды истории

| Команда            | Описание                                                                            | Разрешение             | Пример использования |
| ------------------------- | ------------------------------------------------------------------------------------------- | -------------------------------- | --------------------------------------- |
| `/history`              | Отображает все записи о смертях жителей                   | `newplayerpanel.history`       | `/history`                            |
| `/history <player>`     | Показывает записи для конкретного игрока                | `newplayerpanel.history`       | `/history Steve`                      |
| `/history <x> <y> <z>`  | Показывает записи рядом с координатами                    | `newplayerpanel.history`       | `/history 100 64 200`                 |
| `/history coords`       | Показывает записи в вашем текущем местоположении | `newplayerpanel.history`       | `/history coords`                     |
| `/history purge <time>` | Удаляет записи старше указанного времени                | `newplayerpanel.history.purge` | `/history purge 7d`                   |

**Примеры формата времени:**

- `7d` - 7 дней
- `30d` - 30 дней
- `1h` - 1 час
- `2w` - 2 недели
- `1M` - 1 месяц

### Команды управления ограничениями

| Команда                              | Описание                                                          | Разрешение                        | Пример использования |
| ------------------------------------------- | ------------------------------------------------------------------------- | ------------------------------------------- | --------------------------------------- |
| `/restrict <player> <restriction> <time>` | Применяет ограничение к игроку                 | `newplayerpanel.restrictions.restrict`    | `/restrict Steve elytra_ban 3600`     |
| `/unrestrict <player> <restriction\|all>`  | Удаляет ограничение(я) у игрока                 | `newplayerpanel.restrictions.restrict`    | `/unrestrict Steve elytra_ban`        |
| `/restrictions`                           | Отображает ваши активные ограничения     | `newplayerpanel.restrictions.view`        | `/restrictions`                       |
| `/restrictions [player]`                  | Отображает активные ограничения игрока | `newplayerpanel.restrictions.view.others` | `/restrictions Steve`                 |

**Значения времени:**

- `-1` - Постоянное ограничение
- `0` - Удалить ограничение
- `>0` - Длительность в секундах (например, `3600` = 1 час)

**Примечание:** Игроки могут просматривать свои ограничения, используя `/restrictions` без аргументов. Администраторы могут просматривать ограничения других игроков, указав имя игрока.

### Команды защиты спавна

Доступны всем (без специального разрешения):

| Команда | Описание | Пример |
| ------- | -------- | ------ |
| `/spawnprotect info` | Информация о модуле: включён/выключен, число зон, настройка обхода по времени в игре | `/spawnprotect info` |
| `/spawnprotect playtime` | Ваше время в игре и (если включён bypass) оставшееся время до обхода ограничений | `/spawnprotect playtime` |

Только для администраторов (`newplayerpanel.spawnprotect.admin`):

| Команда | Описание | Пример |
| ------- | -------- | ------ |
| `/spawnprotect playtime [игрок]` | Время в игре любого игрока | `/spawnprotect playtime Steve` |
| `/spawnprotect list` | Список зон с типом и размерами | `/spawnprotect list` |
| `/spawnprotect add <имя> [радиус]` | Добавить круглую зону (подтверждение: `... add <имя> confirm`) | `/spawnprotect add spawn 100` |
| `/spawnprotect add <имя> rect` | Добавить прямоугольную зону по `pos1`/`pos2` (подтверждение: `... add <имя> rect confirm`) | `/spawnprotect add market rect` |
| `/spawnprotect remove <имя>` | Удалить зону (подтверждение: `... remove <имя> confirm`) | `/spawnprotect remove spawn` |
| `/spawnprotect pos1` | Запомнить 1-й угол прямоугольника (текущая позиция) | `/spawnprotect pos1` |
| `/spawnprotect pos2` | Запомнить 2-й угол прямоугольника (текущая позиция) | `/spawnprotect pos2` |
| `/spawnprotect addpoint <имя>` | Добавить вершину полигональной зоны (создаёт зону при первой точке, далее добавляет) | `/spawnprotect addpoint arena` |
| `/spawnprotect edit <зона> <параметр> <значение>` | Редактировать параметр зоны | `/spawnprotect edit spawn radius 150` |
| `/spawnprotect reload` | Перезагрузить конфигурацию защиты спавна | `/spawnprotect reload` |

**Создание зон:**

- **Круглая (CIRCLE):** `/spawnprotect add <имя> [радиус]` → `... add <имя> confirm`
- **Прямоугольная (RECT):** встать в 1-й угол → `/spawnprotect pos1` → встать во 2-й угол → `/spawnprotect pos2` → `/spawnprotect add <имя> rect` → `... add <имя> rect confirm`
- **Полигональная (POLY):** обойти вершины и на каждой вызвать `/spawnprotect addpoint <имя>` (минимум 3 точки)

**Редактирование зон (`edit`):**

| Параметр | Описание | Пример |
| -------- | -------- | ------ |
| `radius` | Радиус зоны (CIRCLE) | `/spawnprotect edit spawn radius 200` |
| `center` | Центр зоны = текущая позиция (CIRCLE) | `/spawnprotect edit spawn center` |
| `world` | Мир зоны = текущий мир | `/spawnprotect edit spawn world` |
| `pvp` | Защита от PvP | `/spawnprotect edit spawn pvp true` |
| `explosions` | Защита от взрывов | `/spawnprotect edit spawn explosions false` |
| `fire-spread` | Защита от огня | `/spawnprotect edit spawn fire-spread true` |
| `removepoint` | Удалить вершину полигона по индексу (POLY) | `/spawnprotect edit arena removepoint 2` |

**Подтверждение:** Добавление и удаление зон требуют повторной команды с аргументом `confirm` в течение 30 секунд.

---

## Разрешения

| Узел разрешения               | Описание                                                                        | Доступ по умолчанию |
| ------------------------------------------- | --------------------------------------------------------------------------------------- | ------------------------------------ |
| `newplayerpanel.admin`                    | Полный административный доступ к командам `/npp` | Только операторы      |
| `newplayerpanel.history`                  | Просмотр записей истории смертей жителей            | Только операторы      |
| `newplayerpanel.history.purge`            | Разрешение на очистку старых записей истории     | Только операторы      |
| `newplayerpanel.notify`                   | Получение уведомлений о смертях жителей              | Только операторы      |
| `newplayerpanel.restrictions.bypass`      | Обход всех ограничений из конфигурации                | Только операторы      |
| `newplayerpanel.restrictions.restrict`    | Применение и удаление ограничений игроков          | Только операторы      |
| `newplayerpanel.restrictions.view`        | Просмотр ваших активных ограничений                     | Все игроки                  |
| `newplayerpanel.restrictions.view.others` | Просмотр ограничений других игроков                     | Только операторы      |
| `newplayerpanel.spawnprotect.admin`      | Управление зонами (list, add, remove, reload), просмотр времени в игре любого игрока | Только операторы      |
| `newplayerpanel.spawnprotect.bypass`      | Обход защиты спавна                                                    | Только операторы      |

---

## Конфигурация

### Основной файл конфигурации (`config.yml`)

```yaml
language: ru
storage: H2
database:
  host: localhost
  port: 3306
  database: newplayerpanel
  username: root
  password: ""
  pool:
    maximum-pool-size: 10
    minimum-idle: 2
    connection-timeout: 30000
    idle-timeout: 600000
    max-lifetime: 1800000

villager-tracker:
  only-traded: true
  notify-enabled: true
  save-debug-files: false

spawn-protect:
  enabled: true
```

### Конфигурация защиты спавна (`spawnprotect.yml`)

Поддерживаются три типа зон: **CIRCLE** (по умолчанию), **RECT**, **POLY**.

```yaml
# Bypass по времени игры (в секундах, 0 = выключено)
bypass-after-playtime: 0

# Типы зон:
#   CIRCLE — центр + радиус
#   RECT   — прямоугольник (min/max углы)
#   POLY   — полигон (список вершин, минимум 3)

zones:
  # --- Круглая зона ---
  spawn:
    world: world
    type: CIRCLE
    center:
      x: 0
      z: 0
    radius: 100

    block-break:
      enabled: true
      mode: WHITELIST
      list: []
    block-place:
      enabled: true
      mode: WHITELIST
      list: []
    interact:
      enabled: true
      mode: WHITELIST
      list:
        - ENDER_CHEST
        - CRAFTING_TABLE
        - ENCHANTING_TABLE
        - ANVIL
        - SMITHING_TABLE
        - GRINDSTONE
        - STONECUTTER
    entity-interact:
      enabled: false
      mode: WHITELIST
      list:
        - VILLAGER
        - WANDERING_TRADER
    pvp:
      enabled: true
    explosions:
      enabled: true
    fire-spread:
      enabled: true

  # --- Прямоугольная зона ---
  # z1:
  #   type: RECT
  #   min:
  #     x: -50
  #     z: -30
  #   max:
  #     x: 50
  #     z: 30

  # --- Полигональная зона ---
  # z2:
  #   type: POLY
  #   points:
  #     - {x: 100, z: 100}
  #     - {x: 200, z: 100}
  #     - {x: 250, z: 200}
  #     - {x: 150, z: 250}
  #     - {x: 50, z: 200}
```

### Файл конфигурации ограничений (`restrictions.yml`)

```yaml
restrictions:
  - name: elytra_ban
    type: EQUIPMENT
    actions: EQUIP
    item: [minecraft:elytra]
    time: -1
    default: false
  
  - name: tnt_restriction
    type: ITEM
    actions: USE
    item: [minecraft:tnt]
    time: 28800
    default: true
  
  - name: villager_hit_restriction
    type: ENTITY
    actions: DAMAGE
    entity: [minecraft:villager]
    time: -1
    default: false
```

### Типы ограничений

| Тип        | Описание                                                                                       | Поле цели |
| ------------- | ------------------------------------------------------------------------------------------------------ | ----------------- |
| `EQUIPMENT` | Ограничивает экипировку предметов в слотах брони/элитр | `item`          |
| `ITEM`      | Ограничивает использование или размещение предметов     | `item`          |
| `ENTITY`    | Ограничивает взаимодействие с сущностями                          | `entity`        |
| `COMMAND`   | Ограничивает выполнение команд                                             | `command`       |

### Типы действий

| Действие | Описание                                                              |
| ---------------- | ----------------------------------------------------------------------------- |
| `DAMAGE`       | Нанесение урона сущностям                              |
| `USE`          | Использование или размещение предметов     |
| `DROP`         | Выбрасывание предметов                                   |
| `EQUIP`        | Экипировка предметов в слотах брони/элитр |
| `EXECUTE`      | Выполнение команд                                             |

### Логика ограничений

**Ограничения по умолчанию:**

- Когда `default: true`, ограничения применяются автоматически ко всем игрокам
- Время рассчитывается от **первого входа игрока** (не от времени запуска сервера)
- Пример: Если `time: 3600` (1 час), ограничение применяется в течение первого часа после первого входа игрока
- Если `time: -1`, ограничение постоянно для всех игроков
- Ограничения по умолчанию автоматически удаляются при истечении времени

**Персональные ограничения:**

- Применяются через команду `/restrict`
- Время рассчитывается от **момента применения** (не от первого входа игрока)
- Персональные ограничения **переопределяют** ограничения по умолчанию
- Если у игрока есть персональное ограничение, ограничения по умолчанию с тем же именем игнорируются
- Персональные ограничения могут быть удалены вручную с помощью `/unrestrict`

**Порядок приоритета:**

1. Персональные ограничения (наивысший приоритет)
2. Ограничения по умолчанию (если персонального ограничения нет)

**Просмотр ограничений:**

- Игроки могут просматривать свои ограничения: `/restrictions`
- Администраторы могут просматривать ограничения любого игрока: `/restrictions <player>`
- Отображаются как персональные, так и ограничения по умолчанию с оставшимся временем

---

## Системы хранения

### Хранение YAML/JSON

Файловое хранение с использованием формата JSON. Все данные хранятся в `plugins/NewPlayerPanel/data/`:

- `messages.json` - Сообщения локализации
- `villager_deaths.json` - Записи о смертях жителей
- `restrictions.json` - Данные об ограничениях игроков

**Преимущества:**

- Не требуется настройка базы данных
- Легко создавать резервные копии (копировать файлы)
- Читаемый формат

**Конфигурация:**

```yaml
storage: YAML
```

### База данных H2 (По умолчанию)

Встроенная база данных SQLite, хранящаяся как `plugins/NewPlayerPanel/database.db`.

**Преимущества:**

- Нет внешних зависимостей
- Автоматическая настройка
- Хорошая производительность для малых и средних серверов

**Конфигурация:**

```yaml
storage: H2
```

### База данных MySQL

Полная интеграция с базой данных MySQL с пулом соединений через HikariCP.

**Преимущества:**

- Масштабируемость для больших серверов
- Поддержка нескольких экземпляров сервера
- Расширенные возможности запросов

**Конфигурация:**

```yaml
storage: MYSQL
database:
  host: localhost
  port: 3306
  database: newplayerpanel
  username: root
  password: your_password
```

### База данных MariaDB

Нативная поддержка MariaDB с оптимизированной обработкой соединений.

**Преимущества:**

- Совместимость с функциями MariaDB
- Высокая производительность
- Надежность корпоративного уровня
- Оптимизированное подключение с правильными параметрами
- Автоматическая проверка и добавление колонок для обратной совместимости

**Конфигурация:**

```yaml
storage: MARIADB
database:
  host: localhost
  port: 3306
  database: newplayerpanel
  username: root
  password: your_password
  pool:
    maximum-pool-size: 10
    minimum-idle: 2
    connection-timeout: 30000
    idle-timeout: 600000
    max-lifetime: 1800000
```

## Совместимость

### Поддерживаемое серверное ПО

- **Spigot** - Полная совместимость
- **Purpur** - Полная совместимость
- **Любой сервер на основе Bukkit** - Совместим со стандартным API Bukkit

### Версии Minecraft

- **1.21.x** - Полностью поддерживается
- Будущие версии - Должны работать с API версии 1.20+

### Требования к Java

- **Java 17** - Минимальная требуемая версия
- **Java 21** - Рекомендуется для оптимальной производительности

### Требования к базе данных (если используется MySQL/MariaDB)

- **MySQL 8.0+**
- **MariaDB 10.3+**
- База данных должна поддерживать кодировку UTF-8

---

## Поддержка и документация

- **Автор:** Math_Tereegor
- **Помощь и поддержка:** MISQZY и 6oJIeH
- **Версия плагина:** 3.0.6
